const whatsappService = require('../../services/whatsappService');
const HelperUtils = require('../../utils/helpers');
const ValidationUtils = require('../../middleware/validation');
const CONSTANTS = require('../../utils/constants');

class ConstructionFlow {
    async processStep(phone, step, messageText, buttonId, userSession) {
        switch (step) {
            case 'start':
                return this.showMainMenu(phone, userSession);

            case 'main_menu':
                return this.handleMainMenu(phone, buttonId, userSession);

                // Project Inquiry Flow
            case 'inquiry_start':
                return this.startProjectInquiry(phone, userSession);
            case 'inquiry_type':
                return this.handleInquiryType(phone, buttonId, userSession);
            case 'inquiry_form':
                return this.handleInquiryForm(phone, messageText, buttonId, userSession);
            case 'inquiry_complete':
                return this.completeInquiry(phone, buttonId, userSession);

                // Cost Estimation Flow
            case 'estimate_start':
                return this.startCostEstimation(phone, userSession);
            case 'estimate_form':
                return this.handleEstimationForm(phone, messageText, buttonId, userSession);
            case 'estimate_complete':
                return this.completeEstimation(phone, buttonId, userSession);

                // Site Visit Flow
            case 'visit_start':
                return this.startSiteVisit(phone, userSession);
            case 'visit_form':
                return this.handleVisitForm(phone, messageText, buttonId, userSession);
            case 'visit_complete':
                return this.completeVisit(phone, buttonId, userSession);

            default:
                return this.showMainMenu(phone, userSession);
        }
    }

    async showMainMenu(phone, userSession) {
        const menuText = `üèóÔ∏è *Welcome to ConstructBot*\n\n` +
            `Hello ${userSession.name || 'there'}! We provide comprehensive construction solutions.\n\n` +
            `*Our Services:*\n` +
            `üè† Residential Projects\n` +
            `üè¢ Commercial Buildings\n` +
            `üîß Renovation & Repairs\n\n` +
            `*How can we help you today?*`;

        await whatsappService.sendButtonMessage(
            phone,
            menuText, [
                { id: 'new_inquiry', title: 'üèóÔ∏è New Project' },
                { id: 'cost_estimate', title: 'üí∞ Cost Estimate' },
                { id: 'site_visit', title: 'üìç Site Visit' }
            ]
        );

        return { nextStep: 'main_menu' };
    }

    async handleMainMenu(phone, buttonId, userSession) {
        switch (buttonId) {
            case 'new_inquiry':
                return this.startProjectInquiry(phone, userSession);
            case 'cost_estimate':
                return this.startCostEstimation(phone, userSession);
            case 'site_visit':
                return this.startSiteVisit(phone, userSession);
            case 'main_menu':
                return { nextFlow: 'main', nextStep: 'welcome' };
            default:
                await whatsappService.sendTextMessage(
                    phone,
                    "Please select one of the available options üëÜ"
                );
                return { nextStep: 'main_menu' };
        }
    }

    // ==================== PROJECT INQUIRY FLOW ====================
    async startProjectInquiry(phone, userSession) {
        const inquiryText = `üèóÔ∏è *New Project Inquiry*\n\n` +
            `Let's gather details about your construction project.\n\n` +
            `*What type of project are you planning?*`;

        await whatsappService.sendButtonMessage(
            phone,
            inquiryText, [
                { id: 'residential', title: 'üè† Residential' },
                { id: 'commercial', title: 'üè¢ Commercial' },
                { id: 'renovation', title: 'üî® Renovation' }
            ]
        );

        return { nextStep: 'inquiry_type' };
    }

    async handleInquiryType(phone, buttonId, userSession) {
        const projectTypes = {
            residential: 'Residential Construction',
            commercial: 'Commercial Building',
            renovation: 'Renovation Work'
        };

        const selectedType = projectTypes[buttonId];
        if (!selectedType) {
            await whatsappService.sendTextMessage(phone, "Please select a valid project type.");
            return { nextStep: 'inquiry_type' };
        }

        await whatsappService.sendTextMessage(
            phone,
            `‚úÖ *${selectedType} Selected*\n\nüìù Please provide your full name:`
        );

        return {
            nextStep: 'inquiry_form',
            data: {
                inquiryForm: {
                    projectType: selectedType,
                    step: 'collect_name'
                }
            }
        };
    }

    async handleInquiryForm(phone, messageText, buttonId, userSession) {
        // Initialize form if not exists
        if (!userSession.data || !userSession.data.inquiryForm) {
            return { nextStep: 'inquiry_start' };
        }

        const form = userSession.data.inquiryForm;

        switch (form.step) {
            case 'collect_name':
                if (!ValidationUtils.isValidName(messageText)) {
                    await whatsappService.sendTextMessage(
                        phone,
                        "‚ùå Please provide a valid name (2-50 characters):"
                    );
                    return { nextStep: 'inquiry_form' };
                }

                form.customerName = messageText;
                form.step = 'collect_location';

                await whatsappService.sendTextMessage(
                    phone,
                    "üìç Please provide project location:\n\n*Format:* City, State"
                );
                break;

            case 'collect_location':
                if (!messageText || messageText.length < 5) {
                    await whatsappService.sendTextMessage(
                        phone,
                        "‚ùå Please provide a valid location:"
                    );
                    return { nextStep: 'inquiry_form' };
                }

                form.location = messageText;
                form.step = 'select_budget';

                await whatsappService.sendButtonMessage(
                    phone,
                    "üí∞ What's your budget range?", [
                        { id: 'budget_5_15', title: 'üí∞ ‚Çπ5-15 Lakhs' },
                        { id: 'budget_15_30', title: 'üí∞ ‚Çπ15-30 Lakhs' },
                        { id: 'budget_30_plus', title: 'üí∞ ‚Çπ30+ Lakhs' }
                    ]
                );
                break;

            case 'select_budget':
                const budgetMap = {
                    'budget_5_15': '‚Çπ5-15 Lakhs',
                    'budget_15_30': '‚Çπ15-30 Lakhs',
                    'budget_30_plus': '‚Çπ30+ Lakhs'
                };

                form.budget = budgetMap[buttonId] || 'Not specified';
                form.step = 'completed';

                return this.completeInquiry(phone, null, userSession);

            default:
                return { nextStep: 'inquiry_form' };
        }

        return {
            nextStep: 'inquiry_form',
            data: { inquiryForm: form }
        };
    }

    async completeInquiry(phone, buttonId, userSession) {
        // Handle navigation buttons
        if (buttonId) {
            switch (buttonId) {
                case 'cost_estimate':
                    return this.startCostEstimation(phone, userSession);
                case 'site_visit':
                    return this.startSiteVisit(phone, userSession);
                case 'main_menu':
                    return { nextFlow: 'main', nextStep: 'welcome' };
                default:
                    break;
            }
        }

        const form = userSession.data.inquiryForm;
        const inquiryId = `CONST${Date.now().toString().slice(-6)}`;

        const summaryText = `‚úÖ *Project Inquiry Submitted!*\n\n` +
            `*Inquiry ID:* ${inquiryId}\n\n` +
            `*Details:*\n` +
            `üë§ Name: ${form.customerName}\n` +
            `üèóÔ∏è Type: ${form.projectType}\n` +
            `üìç Location: ${form.location}\n` +
            `üí∞ Budget: ${form.budget}\n\n` +
            `*Next Steps:*\n` +
            `‚Ä¢ Team will review inquiry\n` +
            `‚Ä¢ Site visit will be scheduled\n` +
            `‚Ä¢ You'll get a call within 24hrs\n\n` +
            `*Thank you for choosing us!*`;

        await whatsappService.sendTextMessage(phone, summaryText);

        await whatsappService.sendButtonMessage(
            phone,
            "*What's next?*", [
                { id: 'cost_estimate', title: 'üí∞ Get Estimate' },
                { id: 'site_visit', title: 'üìç Site Visit' },
                { id: 'main_menu', title: 'üè† Main Menu' }
            ]
        );

        return { nextStep: 'inquiry_complete' };
    }

    // ==================== COST ESTIMATION FLOW ====================
    async startCostEstimation(phone, userSession) {
        const estimationText = `üí∞ *Construction Cost Estimation*\n\n` +
            `Get approximate cost for your project.\n\n` +
            `*Select project type:*`;

        await whatsappService.sendButtonMessage(
            phone,
            estimationText, [
                { id: 'new_construction', title: 'üèóÔ∏è New Build' },
                { id: 'renovation_work', title: 'üî® Renovation' },
                { id: 'interior_work', title: 'üé® Interior' }
            ]
        );

        return { nextStep: 'estimate_form', data: { estimateForm: { step: 'select_type' } } };
    }

    async handleEstimationForm(phone, messageText, buttonId, userSession) {
        // Initialize form if not exists
        if (!userSession.data || !userSession.data.estimateForm) {
            userSession.data = { estimateForm: { step: 'select_type' } };
        }

        const form = userSession.data.estimateForm;

        switch (form.step) {
            case 'select_type':
                const typeMap = {
                    'new_construction': 'New Construction',
                    'renovation_work': 'Renovation Work',
                    'interior_work': 'Interior Work'
                };

                form.projectType = typeMap[buttonId] || 'New Construction';
                form.step = 'collect_area';

                await whatsappService.sendTextMessage(
                    phone,
                    `‚úÖ *${form.projectType} Selected*\n\nüìè Enter area in square feet:\n\n*Example:* 1200`
                );
                break;

            case 'collect_area':
                const area = parseInt(messageText);
                if (isNaN(area) || area <= 0 || area > 10000) {
                    await whatsappService.sendTextMessage(
                        phone,
                        "‚ùå Please enter valid area (1-10,000 sq ft):"
                    );
                    return { nextStep: 'estimate_form' };
                }

                form.area = area;
                form.step = 'select_quality';

                await whatsappService.sendButtonMessage(
                    phone,
                    "‚≠ê Select construction quality:", [
                        { id: 'basic', title: 'üîß Basic' },
                        { id: 'standard', title: 'üè† Standard' },
                        { id: 'premium', title: '‚≠ê Premium' }
                    ]
                );
                break;

            case 'select_quality':
                const qualityMap = {
                    'basic': 'Basic Quality',
                    'standard': 'Standard Quality',
                    'premium': 'Premium Quality'
                };

                form.quality = qualityMap[buttonId] || 'Standard Quality';
                form.step = 'completed';

                return this.completeEstimation(phone, null, userSession);

            default:
                return { nextStep: 'estimate_form' };
        }

        return {
            nextStep: 'estimate_form',
            data: { estimateForm: form }
        };
    }

    async completeEstimation(phone, buttonId, userSession) {
        // Handle navigation buttons
        if (buttonId) {
            switch (buttonId) {
                case 'new_inquiry':
                    return this.startProjectInquiry(phone, userSession);
                case 'site_visit':
                    return this.startSiteVisit(phone, userSession);
                case 'main_menu':
                    return { nextFlow: 'main', nextStep: 'welcome' };
                default:
                    break;
            }
        }

        const form = userSession.data.estimateForm;
        const costBreakdown = this.calculateCost(form);

        const estimationText = `üí∞ *Cost Estimation Report*\n\n` +
            `*Project Details:*\n` +
            `üèóÔ∏è Type: ${form.projectType}\n` +
            `üìè Area: ${form.area} sq ft\n` +
            `‚≠ê Quality: ${form.quality}\n\n` +
            `*Cost Breakdown:*\n` +
            `üß± Materials: ${HelperUtils.formatCurrency(costBreakdown.materials)}\n` +
            `üë∑ Labor: ${HelperUtils.formatCurrency(costBreakdown.labor)}\n` +
            `üîß Other: ${HelperUtils.formatCurrency(costBreakdown.others)}\n` +
            `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
            `üí∞ *Total: ${HelperUtils.formatCurrency(costBreakdown.total)}*\n\n` +
            `*Per sq ft: ${HelperUtils.formatCurrency(costBreakdown.perSqFt)}*\n\n` +
            `‚ö†Ô∏è *Note:* Approximate estimate. Final cost may vary.\n\n` +
            `*Estimate ID:* EST${Date.now().toString().slice(-6)}`;

        await whatsappService.sendTextMessage(phone, estimationText);

        await whatsappService.sendButtonMessage(
            phone,
            "*What's next?*", [
                { id: 'new_inquiry', title: 'üèóÔ∏è Start Project' },
                { id: 'site_visit', title: 'üìç Site Visit' },
                { id: 'main_menu', title: 'üè† Main Menu' }
            ]
        );

        return { nextStep: 'estimate_complete' };
    }

    // ==================== SITE VISIT FLOW ====================
    async startSiteVisit(phone, userSession) {
        const visitText = `üìç *Schedule Site Visit*\n\n` +
            `Our expert will visit for:\n\n` +
            `‚Ä¢ Project assessment\n` +
            `‚Ä¢ Measurements\n` +
            `‚Ä¢ Technical consultation\n` +
            `‚Ä¢ Quotation preparation\n\n` +
            `*What type of visit?*`;

        await whatsappService.sendButtonMessage(
            phone,
            visitText, [
                { id: 'new_project', title: 'üèóÔ∏è New Project' },
                { id: 'renovation', title: 'üî® Renovation' },
                { id: 'consultation', title: 'üí≠ Consultation' }
            ]
        );

        return { nextStep: 'visit_form', data: { visitForm: { step: 'select_type' } } };
    }

    async handleVisitForm(phone, messageText, buttonId, userSession) {
        // Initialize form if not exists
        if (!userSession.data || !userSession.data.visitForm) {
            userSession.data = { visitForm: { step: 'select_type' } };
        }

        const form = userSession.data.visitForm;

        switch (form.step) {
            case 'select_type':
                const typeMap = {
                    'new_project': 'New Project Assessment',
                    'renovation': 'Renovation Planning',
                    'consultation': 'Technical Consultation'
                };

                form.visitType = typeMap[buttonId] || 'New Project Assessment';
                form.step = 'collect_address';

                await whatsappService.sendTextMessage(
                    phone,
                    `‚úÖ *${form.visitType} Selected*\n\nüìç Provide complete site address:\n\n*Include landmarks and PIN code*`
                );
                break;

            case 'collect_address':
                if (!messageText || messageText.length < 10) {
                    await whatsappService.sendTextMessage(
                        phone,
                        "‚ùå Please provide complete address with PIN code:"
                    );
                    return { nextStep: 'visit_form' };
                }

                form.address = messageText;
                form.step = 'select_date';

                await whatsappService.sendButtonMessage(
                    phone,
                    "üìÖ Preferred date for visit:", [
                        { id: 'today', title: 'üìÖ Today' },
                        { id: 'tomorrow', title: 'üìÖ Tomorrow' },
                        { id: 'weekend', title: 'üìÖ Weekend' }
                    ]
                );
                break;

            case 'select_date':
                const dateMap = {
                    'today': 'Today',
                    'tomorrow': 'Tomorrow',
                    'weekend': 'This Weekend'
                };

                form.preferredDate = dateMap[buttonId] || 'Tomorrow';
                form.step = 'collect_contact';

                await whatsappService.sendTextMessage(
                    phone,
                    "üë§ Contact person name who will be at site:"
                );
                break;

            case 'collect_contact':
                if (!ValidationUtils.isValidName(messageText)) {
                    await whatsappService.sendTextMessage(
                        phone,
                        "‚ùå Please provide valid contact person name:"
                    );
                    return { nextStep: 'visit_form' };
                }

                form.contactPerson = messageText;
                form.step = 'completed';

                return this.completeVisit(phone, null, userSession);

            default:
                return { nextStep: 'visit_form' };
        }

        return {
            nextStep: 'visit_form',
            data: { visitForm: form }
        };
    }

    async completeVisit(phone, buttonId, userSession) {
        // Handle navigation buttons
        if (buttonId) {
            switch (buttonId) {
                case 'new_inquiry':
                    return this.startProjectInquiry(phone, userSession);
                case 'cost_estimate':
                    return this.startCostEstimation(phone, userSession);
                case 'main_menu':
                    return { nextFlow: 'main', nextStep: 'welcome' };
                default:
                    break;
            }
        }

        const form = userSession.data.visitForm;
        const visitId = `VISIT${Date.now().toString().slice(-6)}`;

        const confirmationText = `üìç *Site Visit Scheduled!*\n\n` +
            `*Visit ID:* ${visitId}\n\n` +
            `*Details:*\n` +
            `üîß Type: ${form.visitType}\n` +
            `üìç Address: ${form.address}\n` +
            `üìÖ Date: ${form.preferredDate}\n` +
            `üë§ Contact: ${form.contactPerson}\n\n` +
            `*What to expect:*\n` +
            `‚Ä¢ Expert will arrive on time\n` +
            `‚Ä¢ Assessment takes 1-2 hours\n` +
            `‚Ä¢ Detailed report provided\n` +
            `‚Ä¢ Quotation within 24 hours\n\n` +
            `*Confirmation call 1 day before visit*`;

        await whatsappService.sendTextMessage(phone, confirmationText);

        await whatsappService.sendButtonMessage(
            phone,
            "*What's next?*", [
                { id: 'new_inquiry', title: 'üèóÔ∏è New Project' },
                { id: 'cost_estimate', title: 'üí∞ Get Estimate' },
                { id: 'main_menu', title: 'üè† Main Menu' }
            ]
        );

        return { nextStep: 'visit_complete' };
    }

    // ==================== HELPER METHODS ====================
    calculateCost(form) {
        // Base rates per sq ft
        const baseRates = {
            'Basic Quality': 800,
            'Standard Quality': 1200,
            'Premium Quality': 1800
        };

        // Type multipliers
        const typeMultipliers = {
            'New Construction': 1.0,
            'Renovation Work': 0.8,
            'Interior Work': 0.6
        };

        const baseRate = baseRates[form.quality] || 1200;
        const typeMultiplier = typeMultipliers[form.projectType] || 1.0;
        const totalRate = baseRate * typeMultiplier;
        const totalCost = totalRate * form.area;

        // Cost breakdown (approximate percentages)
        const materials = Math.round(totalCost * 0.60); // 60% materials
        const labor = Math.round(totalCost * 0.30); // 30% labor
        const others = totalCost - materials - labor; // 10% others

        return {
            materials,
            labor,
            others,
            total: totalCost,
            perSqFt: Math.round(totalRate)
        };
    }
}

module.exports = new ConstructionFlow();